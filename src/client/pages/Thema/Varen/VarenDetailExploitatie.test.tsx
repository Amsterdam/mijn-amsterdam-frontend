import { render, within } from '@testing-library/react';
import Mockdate from 'mockdate';
import { generatePath } from 'react-router';
import { MutableSnapshot } from 'recoil';
import { afterAll, beforeAll, describe, expect, it } from 'vitest';

import { routeConfig } from './Varen-thema-config';
import { VarenDetail } from './VarenDetail';
import {
  VarenZakenFrontend,
  VarenRegistratieRederType,
  VarenVergunningExploitatieType,
  DecosVarenZaakVergunning,
} from '../../../../server/services/varen/config-and-types';
import { jsonCopy } from '../../../../universal/helpers/utils';
import { AppState } from '../../../../universal/types/App.types';
import { appStateAtom } from '../../../hooks/useAppState';
import MockApp from '../../MockApp';

const VAREN_VERGUNNING_DEFAULT: DecosVarenZaakVergunning = {
  id: 'Z-25-0000001-10001',
  identifier: 'Z/25/0000001-10001',
  vesselName: 'Titanic',
  vesselLength: '2,31',
  vesselWidth: '2,32',
  segment: 'Onbemand',
  eniNumber: '7654321',
};

type ExploitatieAanvraag = VarenZakenFrontend<VarenVergunningExploitatieType>;
const VAREN_DEFAULT = {
  id: 'Z-24-0000001',
  identifier: 'Z/24/0000001',
  key: 'ABCDEF0123456789ABCDEF0123456789',
  caseType: 'Varen vergunning exploitatie',
  title: 'Varen vergunning exploitatie',
  status: 'Afgehandeld',
  decision: 'Verleend',
  processed: false,
  linkDataRequest: null,
  vesselName: 'Titanic',
  vesselLength: '2,31',
  vesselWidth: '2,32',
  vesselHeight: '2,33',
  vesselDepth: '2,34',
  numberOfSeats: 150,
  segment: 'Onbemand',
  formAppearance: 2,
  eniNumber: '7654321',
  steps: [],
  link: { title: 'test', to: 'path' },
} as unknown as ExploitatieAanvraag;

const createSteps = (
  statusActive: ExploitatieAanvraag['status'],
  includeMeerInformatieStep: boolean = false
) => {
  const steps = [
    {
      status: 'Ontvangen' as const,
      datePublished: '2023-11-07T00:00:00',
      description: '',
      isActive: statusActive === 'Ontvangen',
      isChecked: true,
      id: 'step-0',
    },
    {
      status: 'In behandeling' as const,
      datePublished: '2023-11-08T00:00:00',
      description: '',
      isActive: statusActive === 'In behandeling',
      isChecked:
        statusActive !== 'Ontvangen' && statusActive !== 'In behandeling',
      id: 'step-1',
    },
    {
      status: 'Meer informatie nodig' as const,
      datePublished: '2023-11-08T00:00:00',
      description: '',
      isActive: statusActive === 'Meer informatie nodig',
      isChecked:
        statusActive !== 'Ontvangen' &&
        statusActive !== 'In behandeling' &&
        statusActive !== 'Meer informatie nodig',
      id: 'step-2',
    },
    {
      status: 'Afgehandeld' as const,
      datePublished: '2023-11-09T00:00:00',
      isActive: false,
      isChecked: statusActive === 'Afgehandeld',
      id: 'step-3',
    },
  ];

  if (includeMeerInformatieStep) {
    return steps;
  }
  return steps.filter((step) => step.status !== 'Meer informatie nodig');
};

const exploitatieReceived: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  processed: false,
  status: 'Ontvangen',
  steps: createSteps('Ontvangen'),
  dateDecision: null,
  dateDecisionFormatted: null,
};

const exploitatieInProgress: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  status: 'In behandeling',
  processed: false,
  steps: createSteps('In behandeling'),
  dateDecision: null,
  dateDecisionFormatted: null,
};

const exploitatieDecision: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  status: 'Afgehandeld',
  decision: 'Verleend',
  processed: true,
  dateDecisionFormatted: '01 jan 2000',
  vergunning: VAREN_VERGUNNING_DEFAULT,
  steps: createSteps('Afgehandeld'),
};

const rederRegistratie = {
  id: '2801937838',
  title: 'Varen registratie reder',
  caseType: 'Varen registratie reder',
  company: 'Balonnenfabriek',
  bsnkvk: 'KVK',
  address: 'Amstel 1, 1011 PN Amsterdam',
  postalCode: null,
  city: null,
  phone: '0612345678',
  email: 'myemailadres@example.com',
  dateRequest: '2023-11-06T00:00:00',
} as unknown as VarenRegistratieRederType;

const varenZaken = [
  exploitatieReceived,
  exploitatieInProgress,
  exploitatieDecision,
];

const getTestState = (
  zaken: VarenZakenFrontend[] = varenZaken,
  reder: VarenRegistratieRederType | null = rederRegistratie
): AppState =>
  jsonCopy({
    VAREN: {
      content: {
        reder,
        zaken,
      },
      status: 'OK',
    },
  });

function initializeState(snapshot: MutableSnapshot, state: AppState) {
  snapshot.set(appStateAtom, state);
}

const routePath = routeConfig.detailPage.path;
const routeEntry = generatePath(routeConfig.detailPage.path, {
  caseType: 'Varen vergunning exploitatie',
  id: 'Z-24-0000001',
});

describe('<VarenDetail />', () => {
  function Component({ state }: { state: AppState }) {
    return (
      <MockApp
        routePath={routePath}
        routeEntry={routeEntry}
        component={VarenDetail}
        initializeState={(snap) => initializeState(snap, state)}
      />
    );
  }

  beforeAll(() => {
    Mockdate.set('2025-03-04');
  });

  afterAll(() => {
    Mockdate.reset();
  });

  it('Shows the expected title on the page for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );
    expect(screen.getByRole('heading', { level: 3 })).toHaveTextContent(
      'Varen vergunning exploitatie'
    );
  });

  it('Shows the expected texts for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );

    const vesselName = screen.getByText('Naam vaartuig');
    expect(vesselName.nextElementSibling).toHaveTextContent('Titanic');

    const segment = screen.getByText('Segment');
    expect(segment.nextElementSibling).toHaveTextContent('Onbemand');

    const vesselLength = screen.getByText('Lengte vaartuig');
    expect(vesselLength.nextElementSibling).toHaveTextContent('2,31 meter');

    const vesselWidth = screen.getByText('Breedte vaartuig');
    expect(vesselWidth.nextElementSibling).toHaveTextContent('2,32 meter');

    const vergunningKenmerk = screen.getByText('Zaakkenmerk');
    expect(vergunningKenmerk.nextElementSibling).toHaveTextContent(
      'Z/24/0000001'
    );

    const eniNumber = screen.getByText('ENI-nummer');
    expect(eniNumber.nextElementSibling).toHaveTextContent('7654321');
  });

  it('Shows the expected texts for Varen vergunning exploitatie when zaak data is empty', () => {
    const screen = render(
      <Component
        state={getTestState([
          {
            ...exploitatieReceived,
            eniNumber: null,
            vesselWidth: null,
            vesselLength: null,
          },
        ])}
      />
    );

    const vesselName = screen.getByText('Naam vaartuig');
    expect(vesselName.nextElementSibling).toHaveTextContent('Titanic');

    const segment = screen.getByText('Segment');
    expect(segment.nextElementSibling).toHaveTextContent('Onbemand');

    const vesselLength = screen.getByText('Lengte vaartuig');
    expect(vesselLength.nextElementSibling).toHaveTextContent('-');

    const vesselWidth = screen.getByText('Breedte vaartuig');
    expect(vesselWidth.nextElementSibling).toHaveTextContent('-');

    const vergunningKenmerk = screen.getByText('Zaakkenmerk');
    expect(vergunningKenmerk.nextElementSibling).toHaveTextContent(
      'Z/24/0000001'
    );

    const eniNumber = screen.getByText('ENI-nummer');
    expect(eniNumber.nextElementSibling).toHaveTextContent('-');
  });

  it('Shows the expected texts for Varen vergunning exploitatie when vergunning data is empty', () => {
    const screen = render(
      <Component
        state={getTestState([
          {
            ...exploitatieDecision,
            vergunning: {
              ...exploitatieDecision.vergunning!,
              eniNumber: null,
              vesselWidth: null,
              vesselLength: null,
            },
          },
        ])}
      />
    );

    const vesselName = screen.getByText('Naam vaartuig');
    expect(vesselName.nextElementSibling).toHaveTextContent('Titanic');

    const segment = screen.getByText('Segment');
    expect(segment.nextElementSibling).toHaveTextContent('Onbemand');

    const vesselLength = screen.getByText('Lengte vaartuig');
    expect(vesselLength.nextElementSibling).toHaveTextContent('-');

    const vesselWidth = screen.getByText('Breedte vaartuig');
    expect(vesselWidth.nextElementSibling).toHaveTextContent('-');

    const vergunningKenmerk = screen.getByText('Vergunningkenmerk');
    expect(vergunningKenmerk.nextElementSibling).toHaveTextContent('-');

    const eniNumber = screen.getByText('ENI-nummer');
    expect(eniNumber.nextElementSibling).toHaveTextContent('-');
  });

  it('Shows the expected texts for Varen vergunning exploitatie when processed', () => {
    const screen = render(
      <Component state={getTestState([exploitatieDecision])} />
    );

    const vergunningKenmerk = screen.getByText('Vergunningkenmerk');
    expect(vergunningKenmerk.nextElementSibling).toHaveTextContent(
      'Z/25/0000001-10001'
    );

    const result = screen.queryByText('Afgehandeld');
    expect(result).not.toBeInTheDocument();
  });

  it('Shows the status items for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );
    const statusses = within(
      screen.getByText('Status van uw aanvraag').parentElement!
    );
    expect(statusses.getByText('Ontvangen')).toBeInTheDocument();
    expect(statusses.getByText('In behandeling')).toBeInTheDocument();
    expect(
      statusses.queryByText('Meer informatie nodig')
    ).not.toBeInTheDocument();
    expect(statusses.getByText('Afgehandeld')).toBeInTheDocument();
  });

  it('Shows the status items for Varen vergunning exploitatie including the step meer informatie nodig', () => {
    const screen = render(
      <Component
        state={getTestState([
          {
            ...exploitatieReceived,
            steps: createSteps('Meer informatie nodig', true),
          },
        ])}
      />
    );
    const statusses = within(
      screen.getByText('Status van uw aanvraag').parentElement!
    );
    expect(statusses.getByText('Ontvangen')).toBeInTheDocument();
    expect(statusses.getByText('In behandeling')).toBeInTheDocument();
    expect(statusses.getByText('Meer informatie nodig')).toBeInTheDocument();
    expect(statusses.getByText('Afgehandeld')).toBeInTheDocument();
  });

  const BTN_TEXT_WIJZIGEN_EXPLOITATIE = 'Wijzigen';
  describe('Varen vergunning exploitatie action buttons', () => {
    it('Does not show action buttons on Varen vergunning exploitatie received', () => {
      const screen = render(
        <Component state={getTestState([exploitatieReceived])} />
      );
      expect(
        screen.queryByRole('link', { name: BTN_TEXT_WIJZIGEN_EXPLOITATIE })
      ).toBeNull();
    });

    it('Does not show action buttons, wijzings alert or reder alert on Varen vergunning exploitatie in progress', () => {
      const screen = render(
        <Component state={getTestState([exploitatieInProgress])} />
      );
      expect(screen.queryByText(BTN_TEXT_WIJZIGEN_EXPLOITATIE)).toBeNull();

      const alertReder = screen.queryByRole('heading', {
        name: 'Registreer uw onderneming',
      });
      expect(alertReder).not.toBeInTheDocument();

      const alertWijziging = screen.queryByRole('heading', {
        name: 'Wijziging in behandeling',
      });
      expect(alertWijziging).not.toBeInTheDocument();
    });

    it('Shows the action buttons on Varen vergunning exploitatie processed', () => {
      const screen = render(
        <Component state={getTestState([exploitatieDecision])} />
      );
      const btnWijzigen = screen.getByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen.getAttribute('href')).toContain('formulieren');
      expect(btnWijzigen.getAttribute('href')).toContain(
        'guid=ABCDEF0123456789ABCDEF0123456789'
      );
      expect(btnWijzigen).toHaveAttribute('aria-disabled', 'false');
    });

    it('Remove action buttons on Varen vergunning exploitatie when reder is not known and show alert', () => {
      const screen = render(
        <Component state={getTestState([exploitatieDecision], null)} />
      );
      const btnWijzigen = screen.queryByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen).not.toBeInTheDocument();

      const alertReder = screen.queryByRole('heading', {
        name: 'Registreer uw onderneming',
      });
      expect(alertReder).toBeInTheDocument();
    });

    it('Remove action buttons on Varen vergunning exploitatie when vergunning has EV change request in progress and show alert', () => {
      const exploitatieWijziging = {
        ...exploitatieDecision,
        id: 'Z-1-1',
        processed: false,
        decision: null,
        caseType: 'Varen vergunning exploitatie Wijziging vaartuignaam',
        vesselNameNew: 'test',
        link: { title: 'test', to: 'Z-1-1' },
      } as const;
      const screen = render(
        <Component
          state={getTestState([exploitatieDecision, exploitatieWijziging])}
        />
      );
      const btnWijzigen = screen.queryByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen).not.toBeInTheDocument();

      const alertWijziging = screen.queryByRole('heading', {
        name: 'Wijziging in behandeling',
      });
      expect(
        within(alertWijziging!.parentElement!)
          .getByRole('link')
          .getAttribute('href')
      ).toContain(exploitatieWijziging.id);
    });

    it('Does not modify the button text if another vergunning has an EV change request in progress', () => {
      const screen = render(
        <Component
          state={getTestState([
            exploitatieDecision,
            {
              ...exploitatieDecision,
              id: 'Z-1-1',
              vergunning: {
                ...VAREN_VERGUNNING_DEFAULT,
                id: `${exploitatieDecision.vergunning?.id}-notEqual`,
                identifier: `${exploitatieDecision.vergunning?.identifier}-notEqual`,
              },
              processed: false,
              decision: null,
              caseType: 'Varen vergunning exploitatie Wijziging vaartuignaam',
              vesselNameNew: 'test',
            },
          ])}
        />
      );
      const btnWijzigen = screen.queryByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen).toBeInTheDocument();
    });
  });
});
