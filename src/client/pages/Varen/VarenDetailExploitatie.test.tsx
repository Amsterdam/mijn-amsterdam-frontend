import { render, within } from '@testing-library/react';
import Mockdate from 'mockdate';
import { generatePath } from 'react-router-dom';
import { MutableSnapshot } from 'recoil';
import { afterAll, beforeAll, describe, expect, it } from 'vitest';

import { VarenDetail } from './VarenDetail';
import {
  VarenFrontend,
  VarenRegistratieReder,
  VarenVergunningExploitatie,
} from '../../../server/services/varen/config-and-types';
import { AppRoutes } from '../../../universal/config/routes';
import { jsonCopy } from '../../../universal/helpers/utils';
import { AppState } from '../../../universal/types/App.types';
import { appStateAtom } from '../../hooks/useAppState';
import MockApp from '../MockApp';

type ExploitatieAanvraag = VarenFrontend<VarenVergunningExploitatie>;
const VAREN_DEFAULT = {
  id: 'Z-24-0000001',
  identifier: 'Z/24/3421790',
  key: 'ABCDEF0123456789ABCDEF0123456789',
  caseType: 'Varen vergunning exploitatie',
  title: 'Varen vergunning exploitatie',
  status: 'Afgehandeld',
  decision: 'Verleend',
  processed: false,
  linkDataRequest: null,
  vesselName: 'Titanic',
  vesselLength: '2,31',
  vesselWidth: '2,32',
  vesselHeight: '2,33',
  vesselDepth: '2,34',
  numberOfSeats: 150,
  segment: 'Onbemand',
  formAppearance: 2,
  eniNumber: '7654321',
  permitReference: '123456789',
  steps: [],
} as unknown as ExploitatieAanvraag;

const createSteps = (
  statusActive: ExploitatieAanvraag['status'],
  includeMeerInformatieStep: boolean = false
) => {
  const steps = [
    {
      status: 'Ontvangen' as const,
      datePublished: '2023-11-07T00:00:00',
      description: '',
      isActive: statusActive === 'Ontvangen',
      isChecked: true,
      id: 'step-0',
    },
    {
      status: 'In behandeling' as const,
      datePublished: '2023-11-08T00:00:00',
      description: '',
      isActive: statusActive === 'In behandeling',
      isChecked:
        statusActive !== 'Ontvangen' && statusActive !== 'In behandeling',
      id: 'step-1',
    },
    {
      status: 'Meer informatie nodig' as const,
      datePublished: '2023-11-08T00:00:00',
      description: '',
      isActive: statusActive === 'Meer informatie nodig',
      isChecked:
        statusActive !== 'Ontvangen' &&
        statusActive !== 'In behandeling' &&
        statusActive !== 'Meer informatie nodig',
      id: 'step-1',
    },
    {
      status: 'Afgehandeld' as const,
      datePublished: '2023-11-09T00:00:00',
      isActive: false,
      isChecked: statusActive === 'Afgehandeld',
      id: 'step-2',
    },
  ];

  if (includeMeerInformatieStep) {
    return steps;
  }
  return steps.filter((step) => step.status !== 'Meer informatie nodig');
};

const exploitatieReceived: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  processed: false,
  status: 'Afgehandeld',
  steps: createSteps('Ontvangen'),
  dateDecision: null,
  dateDecisionFormatted: null,
};

const exploitatieInProgress: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  status: 'Afgehandeld',
  processed: false,
  steps: createSteps('In behandeling'),
  dateDecision: null,
  dateDecisionFormatted: null,
};

const exploitatieDecision: ExploitatieAanvraag = {
  ...VAREN_DEFAULT,
  status: 'Afgehandeld',
  decision: 'Verleend',
  processed: true,
  steps: createSteps('Afgehandeld'),
};

const rederRegistratie: VarenFrontend<VarenRegistratieReder> = {
  id: '2801937838',
  title: 'Varen registratie reder',
  caseType: 'Varen registratie reder',
  company: 'Balonnenfabriek',
  bsnkvk: 'KVK',
  address: 'Amstel 1, 1011 PN Amsterdam',
  postalCode: null,
  city: null,
  phone: '0612345678',
  email: 'myemailadres@example.com',
  dateRequestFormatted: '06 november 2023',
} as unknown as VarenFrontend<VarenRegistratieReder>;

const varenContent: AppState['VAREN']['content'] = [
  exploitatieReceived,
  exploitatieInProgress,
  exploitatieDecision,
  rederRegistratie,
];

const getTestState = (content: VarenFrontend[] = varenContent): AppState =>
  jsonCopy({
    VAREN: {
      content: content,
      status: 'OK',
    },
  });

function initializeState(snapshot: MutableSnapshot, state: AppState) {
  snapshot.set(appStateAtom, state);
}

const routePath = AppRoutes['VAREN/DETAIL'];
const routeEntry = generatePath(AppRoutes['VAREN/DETAIL'], {
  caseType: 'Varen vergunning exploitatie',
  id: 'Z-24-0000001',
});

describe('<VarenDetail />', () => {
  function Component({ state }: { state: AppState }) {
    return (
      <MockApp
        routePath={routePath}
        routeEntry={routeEntry}
        component={VarenDetail}
        initializeState={(snap) => initializeState(snap, state)}
      />
    );
  }

  beforeAll(() => {
    Mockdate.set('2025-03-04');
  });

  afterAll(() => {
    Mockdate.reset();
  });

  it.only('Shows the expected title on the page for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );
    expect(screen.getByRole('heading', { level: 3 })).toHaveTextContent(
      'Varen vergunning exploitatie'
    );
  });

  it('Shows the expected texts for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );
    const result = screen.getByText('Resultaat');
    expect(result.nextElementSibling).toHaveTextContent('-');

    const vesselName = screen.getByText('Naam vaartuig');
    expect(vesselName.nextElementSibling).toHaveTextContent('Titanic');

    const segment = screen.getByText('Segment');
    expect(segment.nextElementSibling).toHaveTextContent('Onbemand');

    const vesselLength = screen.getByText('Lengte vaartuig');
    expect(vesselLength.nextElementSibling).toHaveTextContent('2,31 meter');

    const vesselWidth = screen.getByText('Breedte vaartuig');
    expect(vesselWidth.nextElementSibling).toHaveTextContent('2,32 meter');

    const permitReference = screen.getByText('Vergunningkenmerk');
    expect(permitReference.nextElementSibling).toHaveTextContent('123456789');

    const eniNumber = screen.getByText('ENI-nummer');
    expect(eniNumber.nextElementSibling).toHaveTextContent('7654321');
  });

  it('Shows the expected texts for Varen vergunning exploitatie when data is empty', () => {
    const screen = render(
      <Component
        state={getTestState([
          {
            ...exploitatieReceived,
            eniNumber: null,
            permitReference: null,
            vesselWidth: null,
            vesselLength: null,
          },
        ])}
      />
    );

    const result = screen.getByText('Resultaat');
    expect(result.nextElementSibling).toHaveTextContent('-');

    const vesselName = screen.getByText('Naam vaartuig');
    expect(vesselName.nextElementSibling).toHaveTextContent('Titanic');

    const segment = screen.getByText('Segment');
    expect(segment.nextElementSibling).toHaveTextContent('Onbemand');

    const vesselLength = screen.getByText('Lengte vaartuig');
    expect(vesselLength.nextElementSibling).toHaveTextContent('-');

    const vesselWidth = screen.getByText('Breedte vaartuig');
    expect(vesselWidth.nextElementSibling).toHaveTextContent('-');

    const permitReference = screen.getByText('Vergunningkenmerk');
    expect(permitReference.nextElementSibling).toHaveTextContent('-');

    const eniNumber = screen.getByText('ENI-nummer');
    expect(eniNumber.nextElementSibling).toHaveTextContent('-');
  });

  it('Shows the expected texts for Varen vergunning exploitatie when processed', () => {
    const screen = render(
      <Component state={getTestState([exploitatieDecision])} />
    );

    const result = screen.getByText('Resultaat');
    expect(result.nextElementSibling).toHaveTextContent('Verleend');
  });

  it('Shows the status items for Varen vergunning exploitatie', () => {
    const screen = render(
      <Component state={getTestState([exploitatieReceived])} />
    );
    const statusses = within(
      screen.getByText('Status van uw aanvraag').parentElement!
    );
    expect(statusses.getByText('Ontvangen')).toBeInTheDocument();
    expect(statusses.getByText('In behandeling')).toBeInTheDocument();
    expect(
      statusses.queryByText('Meer informatie nodig')
    ).not.toBeInTheDocument();
    expect(statusses.getByText('Afgehandeld')).toBeInTheDocument();
  });

  it('Shows the status items for Varen vergunning exploitatie including the step meer informatie nodig', () => {
    const screen = render(
      <Component
        state={getTestState([
          {
            ...exploitatieReceived,
            steps: createSteps('Meer informatie nodig', true),
          },
        ])}
      />
    );
    const statusses = within(
      screen.getByText('Status van uw aanvraag').parentElement!
    );
    expect(statusses.getByText('Ontvangen')).toBeInTheDocument();
    expect(statusses.getByText('In behandeling')).toBeInTheDocument();
    expect(statusses.getByText('Meer informatie nodig')).toBeInTheDocument();
    expect(statusses.getByText('Afgehandeld')).toBeInTheDocument();
  });

  const BTN_TEXT_LIGPLAATS_AANVRAGEN = 'Ligplaatsvergunning aanvragen';
  const BTN_TEXT_WIJZIGEN_EXPLOITATIE = 'Wijzigen';
  describe('Varen vergunning exploitatie action buttons', () => {
    it('Does not show action buttons on Varen vergunning exploitatie received', () => {
      const screen = render(
        <Component state={getTestState([exploitatieReceived])} />
      );
      expect(
        screen.queryByRole('link', { name: BTN_TEXT_WIJZIGEN_EXPLOITATIE })
      ).toBeNull();
      expect(screen.queryByText(BTN_TEXT_LIGPLAATS_AANVRAGEN)).toBeNull();
    });

    it('Does not show action buttons on Varen vergunning exploitatie in progress', () => {
      const screen = render(
        <Component state={getTestState([exploitatieInProgress])} />
      );
      expect(screen.queryByText(BTN_TEXT_WIJZIGEN_EXPLOITATIE)).toBeNull();
      expect(screen.queryByText(BTN_TEXT_LIGPLAATS_AANVRAGEN)).toBeNull();
    });

    it('Shows the action buttons on Varen vergunning exploitatie processed', () => {
      const screen = render(
        <Component
          state={getTestState([exploitatieDecision, rederRegistratie])}
        />
      );
      const btnWijzigen = screen.getByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen.getAttribute('href')).toContain('formulieren');
      expect(btnWijzigen.getAttribute('href')).toContain(
        'guid=ABCDEF0123456789ABCDEF0123456789'
      );
      expect(btnWijzigen).toHaveAttribute('aria-disabled', 'false');

      const btnLigplaatsAanvragen = screen.getByText(
        BTN_TEXT_LIGPLAATS_AANVRAGEN
      );
      expect(btnLigplaatsAanvragen.getAttribute('href')).toContain(
        'formulieren'
      );
      expect(btnLigplaatsAanvragen).toHaveAttribute('aria-disabled', 'false');
    });

    it('Disables action buttons on Varen vergunning exploitatie when reder is not known', () => {
      const screen = render(
        <Component state={getTestState([exploitatieDecision])} />
      );
      const btnWijzigen = screen.queryByRole('link', {
        name: BTN_TEXT_WIJZIGEN_EXPLOITATIE,
      });
      expect(btnWijzigen).not.toBeInTheDocument();

      const btnWijzigenDisabled = screen.getByText(
        BTN_TEXT_WIJZIGEN_EXPLOITATIE
      );
      expect(btnWijzigenDisabled).not.toHaveAttribute('href');
      expect(btnWijzigenDisabled).toHaveAttribute('aria-disabled', 'true');

      const btnLigplaatsAanvragen = screen.queryByRole('link', {
        name: BTN_TEXT_LIGPLAATS_AANVRAGEN,
      });
      expect(btnLigplaatsAanvragen).not.toBeInTheDocument();

      const btnLigplaatsAanvragenDisabled = screen.getByText(
        BTN_TEXT_LIGPLAATS_AANVRAGEN
      );
      expect(btnLigplaatsAanvragenDisabled).not.toHaveAttribute('href');
      expect(btnLigplaatsAanvragenDisabled).toHaveAttribute(
        'aria-disabled',
        'true'
      );
    });
  });
});
